---
title: "Data Management Tools"
output: 
  rmarkdown::html_vignette:
    toc: true
  pdf_document:
    highlight: null
    number_sections: yes
vignette: >
  %\VignetteIndexEntry{Data Management Tools}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---
```{r echo = F}
knitr::opts_chunk$set(echo = TRUE)
```
```{r results='hide', message=FALSE}
library(ready4use)
```
Ready4use includes a number of tools for locating, ingesting, inspecting and sharing data for use in open and modular mental health systems models. 

## Specify remote repositories
The `Ready4useRepos` class can be used to specify details of the data repositories used in your data management workflows. Currently, the two types of repository that can be specified in a `Ready4useRepos` class are Dataverse datasets and GitHub releases. `Ready4useRepos` methods for download / upload extend tools from the `dataverse` and `piggyback` packages.

```{r}
x <- Ready4useRepos(dv_nm_1L_chr = "fakes",
                    dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/HJXYKQ",
                    dv_server_1L_chr = "dataverse.harvard.edu",
                    gh_repo_1L_chr = "ready4-dev/ready4",
                    gh_tag_1L_chr = "Documentation_0.0")
```

## Ingest data
To ingest RDS file format objects contained in the repos specified in an `Ready4useRepos` instance, use the `ingest` method. By default, the `ingest` method imports all RDS files in the specified repositories, but you adopt a more targeted approach by supplying the names of desired files to the `fls_to_ingest_chr` argument. The `ingest` method transforms `x` into an object of class `Ready4useRecord`, which contains both the ingested data and a `Ready4useRepos` instance describing the source repositor(y|ies). 

```{r}
x <- ingest(x,
            fls_to_ingest_chr = c("ymh_clinical_tb","ymh_clinical_dict_r3"))
class(x)
```

## Create a data dyad
The `Ready4useDyad` class can be used to pair a dataset with its data dictionary. In the below example, we create a `Ready4useDyad` instance `y` using some of the data we have just ingested (`x`).

```{r}
y <- Ready4useDyad(ds_tb = x@b_Ready4useIngest@objects_ls$ymh_clinical_tb,
                   dictionary_r3 = x@b_Ready4useIngest@objects_ls$ymh_clinical_dict_r3)
```

The dictionary slot of `y` is an instance of the `ready4use_dictionary` class.

```{r}
class(y@dictionary_r3)
```


## Inspect data
We can inspect `y` by printing selected information about it to console using the `exhibit` method. If we only wish to see the first or last few records, we can pass "head" or "tail" to the `display_1L_chr` argument.

```{r}
 exhibit(y,
         display_1L_chr = "head")
```

The dataset may be more meaningful if variables are labelled using the descriptive information from the data dictionary. This can be accomplished using the `renew` method.

```{r}
y <- renew(y,
           type_1L_chr = "label")
```

```{r}
 exhibit(y,
         display_1L_chr = "head")
```

To remove dataset labels, use the `renew` method with "unlabel" passed to the `type_1L_chr` argument.

```{r}
y <- renew(y,
           type_1L_chr = "unlabel")
```

By default, the `exhibit` method will print the dataset part of the `Ready4useDyad` instance. To inspect the data dictionary, pass "dict" to the `type_1L_chr` argument.

```{r}
exhibit(y,
        type_1L_chr = "dict")
```

## Share data
To share our new object `y`, we first need to specify a target repository that have write permissions to, using the `Ready4usePointer` class.

```{r}
z <- Ready4usePointer(b_Ready4useRepos = Ready4useRepos(dv_nm_1L_chr = "fakes",
                                                        dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/W95KED",
                                                        dv_server_1L_chr = "dataverse.harvard.edu"))
```

We now add details of the target repository to `y`, transforming it to an instance of the `Ready4useRecord` class.

```{r}
y <- Ready4useRecord(a_Ready4usePointer = z,
                     b_Ready4useIngest = Ready4useIngest(objects_ls = list(ymh_clinical_dyad_r4 = y),
                                                         descriptions_chr = c("An example of a Ready4useDyad - a dataset and data dictionary pair. Note this example uses fake data")))
```

We can now post our new `Ready4useDyad` object to our Dataverse dataset (https://doi.org/10.7910/DVN/W95KED). If we wish we can publish the updated dataset in the same step, by using the `publish_dv_1L_lgl` argument. To upload the files to a GitHub Release repository instead, add `type_1L_chr ="gh"` to the function call.

```{r eval = F}
share(y,
      key_1L_chr = "ENTER THE API KEY FOR YOUR REPO HERE",
      publish_dv_1L_lgl = T)
```
